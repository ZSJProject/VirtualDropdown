/* 
*  Name: vsdropdown 
*  Description: Virtual scroll dropdown - AngularJS reusable UI component 
*  Version: 0.1.0 
*  Author: kekeh 
*  Homepage: http://kekeh.github.io/vsdropdown 
*  License: MIT 
*  Date: 2015-09-20 
*/ 
angular.module('template-vsdropdown-0.1.0.html', []).run(['$templateCache', function($templateCache) {
  $templateCache.put("templates/vsdropdown/vsdditemcontent.html",
    "<table class=vsitemcontent><tr><td style=width:18px ng-if=options.input.isObject&&options.input.properties.enabled><span class=\"icon vsiconproperties\" popover-window ng-click=showProperties($event) ng-keydown=\"$event.which===13?showProperties($event):null\" ng-class=\"popover!==null?'icon-down':'icon-right'\" tabindex=0></span></td><td class=vsitemtext tooltip-window>{{getPropertyValue(visiblePropName, item)}}</td><td ng-if=\"id===1\" style=width:16px><span class=\"icon vsiconcross icon-cross\" tabindex=0 ng-click=\"removeItem($index, $event)\" ng-keydown=\"$event.which===13?removeItem($index, $event):null\"></span></td><td class=vsiconcheck ng-if=\"id===2\" ng-show=isItemSelected(item) style=width:22px><span class=\"icon icon-check\"></span></td></tr></table>");
  $templateCache.put("templates/vsdropdown/vsddoverlay.html",
    "<div class=vsoverlay opacity ng-style=\"{'opacity': opacity}\" ng-if=\"showOverlay&&selectedItems.length>1\" ng-mouseleave=closeOverlay()><div class=vsoverlaytitle><span class=vsoverlaytitletext>{{selectedItems.length}} {{options.selection.selectionsTxt}}</span> <span class=\"icon vsiconoverlaycross icon-cross\" ng-click=closeOverlay() ng-keydown=\"$event.which===13?closeOverlay():null\" tabindex=0></span></div><div class=\"vsselecteditem vsselecteditemcolor\" ng-click=$event.stopPropagation() ng-repeat=\"item in selectedItems track by $index\"><div class=vsiteminclude ng-include=\"'templates/vsdropdown/vsdditemcontent.html'\" ng-init=\"id=1\"></div></div></div>");
  $templateCache.put("templates/vsdropdown/vsddpopover.html",
    "<div class=vstooltip style=margin-top:-24px;margin-left:24px opacity ng-style=\"{'opacity': opacity}\"><table class=vsproperties ng-click=closeProperties();$event.stopPropagation()><tr><th>{{options.input.properties.propertyTitle}}</th><th>{{options.input.properties.valueTitle}}</th></tr><tr ng-repeat=\"prop in options.input.properties.props\"><td>{{prop}}</td><td>{{getPropertyValue(prop, item)}}</td></tr></table></div>");
  $templateCache.put("templates/vsdropdown/vsddtooltip.html",
    "<div class=vstooltip style=margin-top:-20px;margin-left:10px opacity ng-style=\"{'opacity': opacity}\" ng-click=closeTooltip($event) ng-keydown=\"$event.which===13?closeTooltip($event):null\" tabindex=0><span class=vstooltiptext>{{getPropertyValue(visiblePropName, item)}}</span></div>");
  $templateCache.put("templates/vsdropdown/vsdropdown.html",
    "<div class=vsdropdown ng-click=$event.stopPropagation() ng-style=\"{'border-radius':showSelector?'2px 2px 0 0':'2px'}\"><div class=vsselectiongroup><div ng-if=\"options.selection.maximum>1\" ng-include=\"'templates/vsdropdown/vsddoverlay.html'\"></div><div class=vsselection ng-style=\"{'padding-right': selectedItems.length>1?'60px':'30px'}\" ng-click=selector()><div class=\"vsselecteditem vsselecteditemcolor\" ng-show=\"$index===0\" ng-click=$event.stopPropagation() ng-repeat=\"item in selectedItems track by $index\"><div class=vsiteminclude ng-include=\"'templates/vsdropdown/vsdditemcontent.html'\" ng-init=\"id=1\"></div></div></div><span class=vsselbtngroup><button class=vsbtnselections ng-if=\"selectedItems.length>1\" ng-click=openOverlay()><span class=\"icon vsiconselections icon-selections\"></span></button> <button class=vsbtnselector ng-click=selector()><span class=\"icon vsiconselector\" ng-class=\"showSelector ? 'icon-up' : 'icon-down'\"></span></button> <span class=vsselectioncounttxt ng-if=\"options.selection.showCount&&selectedItems.length>1\" ng-click=openOverlay()>{{selectedItems.length}}</span></span></div><div class=vsselector ng-show=showSelector><table style=\"width: 100%\" class=vsfiltergroup ng-show=options.filter.enabled ng-class=\"{'vsnohitsfilter': filteredItemCount===0, 'vshitsfilter': filteredItemCount>0}\"><tr><td><input class=vsfilterinput ng-model=filterText ng-model-options=\"{debounce: config.FILTERING_BEGIN_DELAY}\" data-ng-trim=false placeholder={{options.filter.filterPlaceholderTxt}} ng-keydown=keyDown($event) ng-blur=\"focusIdx=-1\"></td><td class=vsfiltermatch><span class=vsfiltermatchtext>{{filteredItemCount>0?filteredItemCount:options.filter.noHitsTxt}}</span></td><td class=vsiconfilterclear style=width:24px ng-show=\"filterText.length>0\"><span class=\"icon vsiconclear icon-clear\" ng-click=clearFilter() ng-keydown=\"$event.which===13?clearFilter():null\" tabindex=0></span></td></tr></table><div class=vsscrollbar vsddscrollbar items=options.items items-in-page={{options.visibleItemCount}} ng-keydown=keyDown($event) ng-focus=focus() ng-blur=blur() list-focus height={{options.visibleItemCount*config.ITEM_HEIGHT+1}} on-scroll-change-fn=\"onScrollChange(topIndex, maxIndex, topPos, maxPos, filteredPageCount, filteredItemCount, visibleItems)\" on-focus-scrollbox-fn=onFocusScrollbox(focused) tabindex=0><div class=vsitem ng-repeat=\"item in visibleItems track by $index\" ng-click=\"itemClicked($index, $event)\" ng-class=\"{'vsselecteditemcolor':isItemSelected(item),'vsfocuseditemcolor':focusIdx===$index}\"><div class=vsiteminclude ng-include=\"'templates/vsdropdown/vsdditemcontent.html'\" ng-init=\"id=2\"></div></div></div></div></div>");
  $templateCache.put("templates/vsscrollbar/vsscrollbar.html",
    "<table class=vsscrollbarcontainer ng-show=\"filteredItems.length>0\" style=border-collapse:separate;border-spacing:0;padding:0;height:100%><tr><td style=width:100%;padding:0;vertical-align:top><div class=vsscrollbarcontent ng-style=\"{'margin': scrollbarVisible?'1px 0 1px 1px':'1px'}\" style=overflow-y:hidden;padding:0;outline:0 ng-transclude></div></td><td style=padding:0;height:100%><div class=vsscrollbar ng-show=scrollbarVisible style=float:right;height:100%;padding:0;margin:1px><div class=vsscrollbox tabindex=0 ng-focus=scrollBoxFocus() ng-blur=scrollBoxBlur() ng-style=\"{'height': boxHeight + 'px'}\" ng-click=$event.stopPropagation() style=position:relative;padding:0;outline:0></div></div></td></tr></table>");
}]);

var _vsdd=angular.module("vsdropdown",["template-vsdropdown-0.1.0.html"]);_vsdd.constant("vsdropdownConfig",{ITEM_HEIGHT:31,LIST_FOCUS_EVENT:"vsdropdown.listFocusEvent",OPERATION_ADD:"+",OPERATION_DEL:"-",DOT_SEPARATOR:".",TOOLTIP_OPEN_DELAY:900,FILTERING_BEGIN_DELAY:500}),_vsdd.service("vsdropdownService",["$templateCache",function(a){this.getTemplate=function(b){return a.get(b)}}]),_vsdd.directive("vsdropdown",["$timeout","vsddsbEvent",function(a,b){return{restrict:"EA",templateUrl:"templates/vsdropdown/vsdropdown.html",scope:{options:"="},controller:["$scope","vsdropdownConfig",function(a,b){a.config=b,a.filterText="",a.showOverlay=!1,a.topIndex=0,a.focusIdx=-1,a.listFocusEvent=function(){a.$broadcast(a.config.LIST_FOCUS_EVENT)}}],link:function(c,d,e){function f(a,b){a!==b&&h()}function g(b,c){b!==c&&a(function(){h()})}function h(){if(c.options.input.isObject){var a={};b.filter(c,i(a))}else b.filter(c,c.filterText)}function i(a){for(var b=c.visiblePropName.split(c.config.DOT_SEPARATOR),d=b.pop(),e=0,f=a;e<b.length;e++)f=f[b[e]]={};return f[d]=c.filterText,a}function j(a,b){angular.isUndefined(c.options.itemSelectCb)||c.options.itemSelectCb(c.selectedItems,a,b)}function k(){return c.focusIdx===c.options.visibleItemCount-1||c.focusIdx===c.filteredItemCount-1}function l(a,b){var d=a.split(c.config.DOT_SEPARATOR),e=angular.copy(b);return angular.forEach(d,function(a){e=e[a]}),e}function m(){c.visiblePropName=c.options.input.isObject?c.options.input.visiblePropName:null,c.selectedItems=c.options.selectedItems}c.selectedItems=["template-vsdropdown-0.1.0.html"],c.showSelector=!1;var n=!1;c.selector=function(){c.showSelector=!c.showSelector,c.showSelector&&(c.listFocusEvent(),c.focusIdx=0)},c.openOverlay=function(){c.showSelector&&c.selector(),c.showOverlay=!0},c.closeOverlay=function(){c.showOverlay=!1},c.itemClicked=function(a,b){var d=c.visibleItems[a];c.isItemSelected(d)?c.removeItem(c.selectedItems.indexOf(d),b):c.addItem(d,b),1===c.options.selection.maximum?c.showSelector=!1:c.focusIdx=a},c.addItem=function(a,b){b.stopPropagation(),c.options.selection.maximum>1?(c.selectedItems.length===c.options.selection.maximum&&c.removeItem(c.selectedItems.length-1,b),c.selectedItems.push(a)):c.selectedItems[0]=a,j(a,c.config.OPERATION_ADD)},c.removeItem=function(a,b){b.stopPropagation();var d=c.selectedItems[a];(a===c.selectedItems.length-1||2===c.selectedItems.length)&&c.closeOverlay(),c.selectedItems.splice(a,1),j(d,c.config.OPERATION_DEL)},c.isItemSelected=function(a){return-1!==c.selectedItems.indexOf(a)},c.getPropertyValue=function(a,b){return null===a?b:-1===a.indexOf(c.config.DOT_SEPARATOR)?b[a]:l(a,b)},c.onScrollChange=function(a,b,d,e,f,g,h){c.topIndex=a,c.filteredItemCount=g,c.visibleItems=h},c.onFocusScrollbox=function(a){n=a},c.keyDown=function(a){n||((13===a.which||38===a.which||40===a.which||27===a.which)&&a.preventDefault(),13===a.which&&c.focusIdx>-1?c.itemClicked(c.focusIdx,a):38===a.which?0===c.focusIdx?(b.setIndex(c,c.topIndex-c.options.visibleItemCount),c.focusIdx=c.filteredItemCount<c.options.visibleItemCount?c.filteredItemCount-1:c.options.visibleItemCount-1):c.focusIdx--:40===a.which?k()?(b.setIndex(c,c.topIndex+c.options.visibleItemCount),c.focusIdx=0):c.focusIdx++:27===a.which&&(c.showSelector=!1))},c.clearFilter=function(){c.filterText="",c.listFocusEvent()};var o=c.$watch("filterText",f),p=c.$watch("options.items.length",g);c.$on("$destroy",function(){o(),p()}),m()}}}]),_vsdd.directive("listFocus",["$timeout",function(a){return{restrict:"A",scope:!1,link:function(b,c,d){b.$on(b.config.LIST_FOCUS_EVENT,function(){a(function(){c[0].focus()})}),b.blur=function(){b.focusIdx=-1},b.focus=function(){b.focusIdx=0}}}}]),_vsdd.directive("tooltipWindow",["$compile","$timeout","vsdropdownService",function(a,b,c){return{restrict:"A",scope:!1,link:function(d,e,f){function g(){e[0].scrollWidth>e[0].offsetWidth&&(m=b(function(){l=angular.element(c.getTemplate("templates/vsdropdown/vsddtooltip.html")),e.append(a(l)(d))},d.config.TOOLTIP_OPEN_DELAY))}function h(){i(),angular.equals(l,null)||(l.remove(),l=null)}function i(){b.cancel(m),m=null}function j(a,b){angular.equals(a,b)||h()}function k(){d.options.showTooltip&&(e.on("mouseenter",g),e.on("mouseleave",h),n=d.$watch("topIndex",j))}var l=null,m=null,n=null;d.closeTooltip=function(a){a.stopPropagation(),h()},d.$on("$destroy",function(){e.off("mouseenter",g),e.off("mouseleave",h),angular.equals(n,null)||n()}),k()}}}]),_vsdd.directive("popoverWindow",["$compile","vsdropdownService",function(a,b){return{restrict:"A",scope:!1,link:function(c,d,e){function f(a,b){angular.equals(a,b)||c.closeProperties()}function g(){h=c.$watch("topIndex",f)}c.popover=null;var h=null;c.showProperties=function(e){e.stopPropagation(),angular.equals(c.popover,null)?(c.popover=angular.element(b.getTemplate("templates/vsdropdown/vsddpopover.html")),d.append(a(c.popover)(c))):c.closeProperties()},c.closeProperties=function(){angular.equals(c.popover,null)||(c.popover.remove(),c.popover=null)},c.$on("$destroy",function(){angular.equals(h,null)||h()}),g()}}}]),_vsdd.directive("opacity",["$interval",function(a){return{restrict:"A",scope:!1,link:function(b,c,d){function e(){b.opacity+=.05}function f(){b.options.fadeInEffects&&(g=a(e,10,20))}b.opacity=b.options.fadeInEffects?0:1;var g=null;b.$on("$destroy",function(){angular.equals(g,null)||a.cancel(g)}),f()}}}]),_vsdd.constant("vssbConf",{ITEMS_IN_PAGE:6,SCROLLBAR_HEIGHT:0,SCROLLBOX_MIN_HEIGHT:18}),_vsdd.factory("vsddsbEvent",function(){function a(a,b,c){a.$broadcast("vsmessage",{type:b,value:c})}var b={};return b.setIndex=function(b,c){a(b,"setIndex",c)},b.setPosition=function(b,c){a(b,"setPosition",c)},b.filter=function(b,c){a(b,"filter",c)},b.addItem=function(b,c,d){a(b,"addItem",{index:c,item:d})},b.updateItem=function(b,c,d){a(b,"updateItem",{index:c,item:d})},b.deleteItem=function(b,c){a(b,"deleteItem",c)},b}),_vsdd.service("vsddsbService",function(){this.calcIndex=function(a,b,c){var d=0;return this.checkIsMaxPos(a,c)?d=b:a>0&&(d=this.validateIndex(Math.round(a/c*b),b)),d},this.calcScrollPos=function(a,b,c){var d=0;return a>0&&(d=this.checkIsMaxIndex(a,b)?c:Math.round(a/b*c)),this.validatePos(d,c,a,b)},this.validateIndex=function(a,b){return 0>=a?0:this.checkIsMaxIndex(a,b)?b:a},this.validatePos=function(a,b,c,d){return angular.isUndefined(c)||angular.isUndefined(d)?0>=a?0:a>=b?b:a:0>=a&&c>0?1:a>=b&&d>c?b-1:a},this.checkIsMaxIndex=function(a,b){return a>=b},this.checkIsMaxPos=function(a,b){return a>=b}}),_vsdd.directive("vsddscrollbar",["$filter","$timeout","$document","vsddsbService","vssbConf",function(a,b,c,d,e){return{restrict:"AE",scope:{ngModel:"=?",items:"=items",onScrollChangeFn:"&",onFocusScrollboxFn:"&"},transclude:!0,templateUrl:"templates/vsscrollbar/vsscrollbar.html",link:function(f,g,h){function i(a){a.preventDefault(),I=angular.isUndefined(a.changedTouches)?a.clientY-L:a.changedTouches[0].clientY-L,c.on(angular.isUndefined(a.changedTouches)?"mousemove":"touchmove",j),c.on(angular.isUndefined(a.changedTouches)?"mouseup":"touchend",k)}function j(a){var b=angular.isUndefined(a.changedTouches)?a.clientY-I:a.changedTouches[0].clientY-I;v(d.validatePos(b,M)),f.$apply()}function k(a){c.off(angular.isUndefined(a.changedTouches)?"mousemove":"touchmove",j),c.off(angular.isUndefined(a.changedTouches)?"mouseup":"touchend",k)}function l(a){I=a.changedTouches[0].clientY,c.on("touchmove",m),c.on("touchend",n)}function m(a){a.preventDefault();var b=a.changedTouches[0].clientY;x(I>b?G:-G),I=b,f.$apply()}function n(){c.off("touchmove",m),c.off("touchend",n)}function o(a){var b=a.offsetY||a.layerY;v(d.validatePos(b<f.boxHeight?0:b,M)),f.$apply()}function p(){F[0].focus()}function q(a){a.preventDefault();var b=(a.wheelDelta||-a.detail)<=0;x(b?G:-G)}function r(a){(38===a.which||40===a.which)&&(a.preventDefault(),x(38===a.which?-G:G))}function s(a,b){"setIndex"===b.type&&b.value!==J&&b.value>=0?w(Math.round(b.value),!0):"setPosition"===b.type&&b.value!==L&&b.value>=0?v(d.validatePos(Math.round(b.value),M)):"filter"===b.type?(N=b.value,t(N,0)):"addItem"===b.type&&b.value.index>=0&&b.value.index<=f.items.length?(f.items.splice(b.value.index,0,b.value.item),t(N,J)):"updateItem"===b.type&&b.value.index>=0&&b.value.index<f.items.length?(f.items[b.value.index]=b.value.item,t(N,J)):"deleteItem"===b.type&&b.value>=0&&b.value<f.items.length&&(f.items.splice(b.value,1),t(N,J))}function t(b,c){f.filteredItems=""===b?f.items:a("filter")(f.items,b),f.scrollbarVisible=f.filteredItems.length>G,u(),w(c,!1)}function u(){var a=Math.floor(H/(f.filteredItems.length/G));f.boxHeight=a<e.SCROLLBOX_MIN_HEIGHT?e.SCROLLBOX_MIN_HEIGHT:a,K=f.filteredItems.length-G<0?0:f.filteredItems.length-G,M=H-f.boxHeight<0?0:H-f.boxHeight}function v(a){(a=Math.round(a))!==L&&(L=a,J=d.calcIndex(L,K,M),y())}function w(a,b){(a=d.validateIndex(a,K))===J&&b||(J=a,L=d.calcScrollPos(J,K,M),y())}function x(a){w(J+a,!0),f.$apply()}function y(){F.css("top",L+"px"),z()}function z(){var a={topIndex:J,maxIndex:K,topPos:L,maxPos:M,filteredPageCount:f.filteredItems.length/G,filteredItemCount:f.filteredItems.length,visibleItems:A()};f.onScrollChangeFn(a),f.ngModel=a}function A(){return f.filteredItems.slice(J,J+G)}function B(){f.filteredItems=f.items,0===H?b(C,0):(E.css("height",H+"px"),u()),w(0,!1)}function C(){H=D.prop("offsetHeight"),E.css("height",H+"px"),u()}f.filteredItems=[];var D=angular.element(g[0].querySelector(".vsscrollbarcontent")),E=angular.element(g[0].querySelector(".vsscrollbar")),F=E.children(),G=angular.isUndefined(h.itemsInPage)?e.ITEMS_IN_PAGE:f.$eval(h.itemsInPage),H=angular.isUndefined(h.height)?e.SCROLLBAR_HEIGHT:f.$eval(h.height),I=0,J=0,K=0,L=0,M=0,N="";f.boxHeight=e.SCROLLBOX_MIN_HEIGHT,f.scrollbarVisible=!0,F.on("mousedown touchstart",i),D.on("touchstart",l),E.on("click",o),F.on("click",p),D.on("mousewheel DOMMouseScroll",q),E.on("mousewheel DOMMouseScroll",q),F.on("keydown",r),f.$on("vsmessage",s),f.$on("$destroy",function(){F.off("mousedown touchstart",i),D.off("touchstart",l),E.off("click",o),F.off("click",p),D.off("mousewheel DOMMouseScroll",q),E.off("mousewheel DOMMouseScroll",q),F.off("keydown",r)}),f.scrollBoxFocus=function(){f.onFocusScrollboxFn({focused:!0})},f.scrollBoxBlur=function(){f.onFocusScrollboxFn({focused:!1})},B()}}}]);